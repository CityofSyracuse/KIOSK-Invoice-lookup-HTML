<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Property Tax Statement Lookup</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { brand: "#002756" },
          },
        },
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>

    <style>
      .table-wrap {
        max-height: 24rem;
        overflow: auto;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
    </style>
  </head>

  <body class="min-h-screen bg-slate-50">
    <div class="bg-white shadow-sm border-b border-gray-200">
      <div
        class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-start sm:items-center gap-4 flex-col sm:flex-row justify-between"
      >
        <div class="flex items-center gap-4 w-full sm:w-auto">
          <button
            onclick="history.back()"
            class="px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg border border-gray-300 transition text-sm"
          >
            ‚Üê Back
          </button>
          <h1 class="text-xl font-semibold text-gray-800 text-center">
            Property Tax Statement Lookup
          </h1>
        </div>

        <a
          href="/"
          class="px-4 py-2 bg-brand text-white rounded-lg hover:opacity-90 transition text-sm flex-shrink-0"
        >
          üè† Home
        </a>
      </div>
    </div>

    <div class="max-w-4xl mx-auto p-4">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <form id="taxForm" class="space-y-4">
          <div>
            <label
              for="q"
              class="block text-gray-700 font-semibold mb-2 text-lg"
            >
              Search by Account # / Name / Address
            </label>

            <input
              id="q"
              type="text"
              class="w-full border border-gray-300 rounded p-3"
              placeholder="Start typing: 165500xxxx ‚Ä¢ Smith ‚Ä¢ Hickok Ave"
              autocomplete="off"
            />

            <p class="mt-1 text-xs text-gray-500">
              Live results show below. Tap
              <strong>View Bill</strong> to open the printable tax bill.
            </p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label for="year" class="block text-gray-700 font-semibold mb-2"
                >Year</label
              >
              <select
                id="year"
                name="year"
                class="w-full border border-gray-300 rounded p-3"
              >
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024" selected>2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
              </select>
            </div>

            <div class="flex items-end">
              <button
                type="submit"
                id="searchBtn"
                class="w-full bg-brand text-white py-3 rounded-lg font-medium hover:opacity-90 transition"
              >
                Search
              </button>
            </div>

            <div class="flex items-end">
              <button
                type="button"
                id="clearBtn"
                class="w-full border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50"
              >
                Clear
              </button>
            </div>
          </div>
        </form>

        <div id="statusLine" class="mt-3 text-sm text-gray-600">
          Loading directory‚Ä¶
        </div>

        <section class="mt-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-gray-800">Matches</h3>
            <span id="matchInfo" class="text-xs text-gray-500"></span>
          </div>

          <div class="table-wrap rounded-lg border bg-white">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 sticky top-0">
                <tr class="text-left">
                  <th class="p-3">Account</th>
                  <th class="p-3">Address</th>
                  <th class="p-3">Name</th>
                  <th class="p-3 w-32">Action</th>
                </tr>
              </thead>
              <tbody id="resultsBody" class="divide-y"></tbody>
            </table>
          </div>

          <p
            id="noResults"
            class="mt-4 hidden rounded-md border border-amber-300 bg-amber-50 p-3 text-amber-900 text-sm"
          >
            No results found. Check spelling or try a different search (name,
            address, or account #). Type your exact account number.
          </p>
        </section>
        <button
          type="button"
          id="toggleKeyboard"
          class="mt-4 text-sm text-blue-600 underline"
        >
          Show Keyboard
        </button>

        <div id="keyboardContainer" class="hidden simple-keyboard"></div>
      </div>
    </div>
    <div id="modal" class="fixed inset-0 z-50 hidden bg-black/75">
      <div class="relative w-full h-full">
        <div
          class="absolute inset-4 bg-white rounded-xl shadow-xl flex flex-col overflow-hidden"
        >
          <div class="flex items-center justify-between p-3 border-b">
            <button
              id="modalClose"
              class="px-4 py-2 text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg border border-gray-300 transition text-sm"
            >
              ‚Üê Back
            </button>
            <h3 class="font-semibold">Tax Statement</h3>
            <button
              id="goHome"
              class="px-4 py-2 bg-brand text-white rounded-lg hover:opacity-90 transition text-sm"
            >
              üè† Home
            </button>
          </div>

          <div class="relative flex-1">
            <div
              id="modalLoader"
              class="absolute inset-0 flex items-center justify-center bg-white/75"
            >
              <div
                class="w-10 h-10 border-4 border-gray-200 border-t-gray-800 rounded-full animate-spin"
              ></div>
            </div>
            <iframe
              id="modalFrame"
              title="Tax Statements"
              class="w-full h-full border-0"
            ></iframe>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-white border-t border-gray-200 py-4 mt-8">
      <div class="max-w-4xl mx-auto text-center">
        <a href="/" class="inline-block">
          <img
            src="/ImagesAssets/cityLogo.png"
            alt="City of Syracuse Logo"
            class="h-8"
          />
        </a>
      </div>
    </footer>

    <script>
      (function () {
        const CSV_URL = "CSV/Data.csv";
        const DISPLAY_LIMIT = 100;

        const directory = [];
        let csvReady = false;

        const qInput = document.getElementById("q");
        const yearSelect = document.getElementById("year");
        const resultsBody = document.getElementById("resultsBody");
        const noResultsEl = document.getElementById("noResults");
        const statusLine = document.getElementById("statusLine");
        const matchInfo = document.getElementById("matchInfo");

        const modal = document.getElementById("modal");
        const frame = document.getElementById("modalFrame");
        const loader = document.getElementById("modalLoader");

        const ABBR = [
          /\bSTREET\b/g,
          /\bAVENUE\b/g,
          /\bROAD\b/g,
          /\bDRIVE\b/g,
          /\bCOURT\b/g,
          /\bNORTH\b/g,
          /\bSOUTH\b/g,
          /\bEAST\b/g,
          /\bWEST\b/g,
        ];
        const REPL = ["ST", "AVE", "RD", "DR", "CT", "N", "S", "E", "W"];

        function clean(s) {
          return (s || "")
            .toString()
            .toUpperCase()
            .replace(/[^A-Z0-9\s&'\.\-]/g, " ")
            .replace(/\s+/g, " ")
            .trim();
        }

        function normalizeAddr(s) {
          let t = clean(s);
          ABBR.forEach((re, i) => (t = t.replace(re, REPL[i])));
          return t;
        }

        function digitsOnly(s) {
          return (s || "").toString().replace(/\D+/g, "");
        }

        function loadCSV() {
          statusLine.textContent = "Loading directory‚Ä¶";
          Papa.parse(CSV_URL, {
            download: true,
            header: false,
            skipEmptyLines: true,
            complete: (res) => {
              const rows = res.data || [];
              const looksBad = !rows.length || rows[0].length < 10;
              if (looksBad) {
                fetch(CSV_URL)
                  .then((r) => r.text())
                  .then((text) => buildIndex(parseSingleQuotedCSV(text)));
              } else {
                buildIndex(rows);
              }
            },
            error: () => {
              fetch(CSV_URL)
                .then((r) => r.text())
                .then((text) => buildIndex(parseSingleQuotedCSV(text)));
            },
          });
        }

        function parseSingleQuotedCSV(text) {
          const out = [];
          const lines = text.split(/\r?\n/);
          for (let line of lines) {
            if (!line) continue;
            if (line[0] === '"' && line[line.length - 1] === '"') {
              line = line.slice(1, -1);
            }
            const row = [];
            let cur = "",
              inQ = false;
            for (let i = 0; i < line.length; i++) {
              const ch = line[i];
              if (ch === "'") {
                inQ = !inQ;
                continue;
              }
              if (ch === "," && !inQ) {
                row.push(cur);
                cur = "";
                continue;
              }
              cur += ch;
            }
            row.push(cur);
            out.push(row.map((x) => x.trim()));
          }
          return out;
        }

        function buildIndex(rows) {
          const seen = new Set();
          for (const r of rows) {
            if (!r || r.length < 48) continue;

            const acct = digitsOnly(r[20]);
            if (!acct) continue;

            // address columns 11 / 12 / 13
            const address = [r[11], r[12], r[13]]
              .filter(Boolean)
              .join(" ")
              .trim();

            // owner name at col 47 (NOTE: full owner block, may include trust / last,first)
            const ownerName = (r[47] || "").toString().trim();

            const key = acct + "|" + address + "|" + ownerName;
            if (seen.has(key)) continue;
            seen.add(key);

            directory.push({
              account: acct,
              address: address,
              name: ownerName,
              hayAddr: normalizeAddr(address),
              hayName: clean(ownerName),
              hayAcct: acct,
            });
          }

          csvReady = true;
          statusLine.textContent = "";
          statusLine.classList.add("hidden");
        }

        function rowMatchesTokens(row, tokens) {
          const hayCombo = row.hayName + " " + row.hayAddr;

          for (const t of tokens) {
            const d = digitsOnly(t);
            if (d) {
              const inAcct = row.hayAcct.includes(d); // account match
              const inAddrNum = row.hayAddr.includes(d);
              if (!inAcct && !inAddrNum) {
                return false;
              }
              continue;
            }

            const T = t;
            const Tshort = T.length > 4 ? T.slice(0, T.length - 1) : T;

            if (!hayCombo.includes(T) && !hayCombo.includes(Tshort)) {
              return false;
            }
          }

          return true;
        }

        function matchRows(query, limit) {
          const raw = clean(query);
          if (!raw) {
            return [];
          }

          const tokens = raw.split(" ").filter(Boolean);
          const out = [];
          for (const row of directory) {
            if (rowMatchesTokens(row, tokens)) {
              out.push(row);
              if (out.length >= limit) break;
            }
          }
          return out;
        }

        function renderResults(rows, hitLimit) {
          resultsBody.innerHTML = "";

          if (!rows.length) {
            if (qInput.value.trim() !== "") {
              noResultsEl.classList.remove("hidden");
            } else {
              noResultsEl.classList.add("hidden");
            }
            matchInfo.textContent = "";
            return;
          }

          noResultsEl.classList.add("hidden");

          rows.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="p-3 mono">${r.account}</td>
              <td class="p-3">${r.address || "‚Äî"}</td>
              <td class="p-3">${r.name || "‚Äî"}</td>
              <td class="p-3">
                <button class="w-full rounded-md bg-brand px-3 py-1.5 text-white hover:opacity-90">
                  View Bill
                </button>
              </td>
            `;

            tr.querySelector("button").addEventListener("click", () => {
              openBill(r.account);
            });

            resultsBody.appendChild(tr);
          });

          matchInfo.textContent = `Showing ${rows.length} ${
            rows.length === 1 ? "match" : "matches"
          }${hitLimit ? " (first " + DISPLAY_LIMIT + " shown)" : ""}`;
        }

        let debounce;
        function doLiveSearch() {
          clearTimeout(debounce);
          debounce = setTimeout(() => {
            if (!csvReady) return;

            const qVal = qInput.value || "";
            const rows = matchRows(qVal, DISPLAY_LIMIT);
            const hitLimit = rows.length >= DISPLAY_LIMIT;
            renderResults(rows, hitLimit);
          }, 120);
        }

        qInput.addEventListener("input", doLiveSearch);
        qInput.addEventListener("focus", doLiveSearch);

        document.getElementById("taxForm").addEventListener("submit", (e) => {
          e.preventDefault();
          doLiveSearch();
          resultsBody.scrollIntoView({ behavior: "smooth", block: "start" });
        });

        document.getElementById("clearBtn").addEventListener("click", () => {
          qInput.value = "";
          doLiveSearch();
          qInput.focus();
        });

        function openBill(account) {
          const year = (
            yearSelect.value || String(new Date().getFullYear())
          ).trim();
          const url = `https://syracuse.go2gov.net/faces/statements?type=cityschool&account=${encodeURIComponent(
            account
          )}&year=${encodeURIComponent(year)}`;

          loader.classList.remove("hidden");
          frame.src = url;
          modal.classList.remove("hidden");
        }

        frame.addEventListener("load", () => {
          loader.classList.add("hidden");
        });

        document.getElementById("modalClose").addEventListener("click", () => {
          frame.src = "about:blank";
          modal.classList.add("hidden");
        });

        document.getElementById("goHome").addEventListener("click", () => {
          window.location.href = "/";
        });

        let activeInput = null;
        const KeyboardClass =
          window.SimpleKeyboard?.default || window.SimpleKeyboard;
        if (KeyboardClass) {
          const keyboard = new KeyboardClass({
            rootElement: document.getElementById("keyboardContainer"),
            theme: "hg-theme-default hg-layout-default",
            display: {
              "{bksp}": "‚å´",
              "{space}": "Space",
              "{enter}": "Enter",
            },
            onChange: (val) => {
              if (activeInput) {
                activeInput.value = val;
                activeInput.dispatchEvent(new Event("input"));
              }
            },
            onKeyPress: (key) => {
              if (key === "{enter}") {
                document.getElementById("taxForm").requestSubmit();
              }
            },
          });

          qInput.addEventListener("focus", () => {
            activeInput = qInput;
            keyboard.setOptions({ inputName: qInput.id });
            keyboard.setInput(qInput.value || "");
          });

          qInput.addEventListener("input", () => {
            if (activeInput === qInput) {
              keyboard.setInput(qInput.value, qInput.id);
            }
          });

          const toggleBtn = document.getElementById("toggleKeyboard");
          const keyboardContainer =
            document.getElementById("keyboardContainer");

          toggleBtn.addEventListener("click", () => {
            if (keyboardContainer.classList.contains("hidden")) {
              (activeInput || qInput).focus();
              keyboardContainer.classList.remove("hidden");
              toggleBtn.textContent = "Hide Keyboard";
            } else {
              keyboardContainer.classList.add("hidden");
              toggleBtn.textContent = "Show Keyboard";
            }
          });
        }

        loadCSV();
      })();
    </script>
  </body>
</html>
